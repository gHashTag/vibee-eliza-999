name: GitHub Issues â†’ Sentry Tracker

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:

env:
  SENTRY_ORG: vasilev-dmitrii
  SENTRY_PROJECT: vibee-eliza-999-prod-2

jobs:
  track-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Debug event
        run: |
          echo "ğŸ” Event Debug:"
          echo "   Event Name: ${{ github.event_name }}"
          echo "   Event Action: ${{ github.event.action }}"
          echo "   Issue Number: ${{ github.event.issue.number }}"
          echo "   Issue Title: ${{ github.event.issue.title }}"
          echo ""

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ action Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚
          if [ "${{ github.event.action }}" != "opened" ] && [ "${{ github.event.action }}" != "reopened" ]; then
            echo "âš ï¸ Skipping: action is ${{ github.event.action }} (expected: opened or reopened)"
            exit 0
          fi

          echo "âœ… Action is valid: ${{ github.event.action }}"

      - name: Track GitHub Issue in Sentry
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          echo "ğŸ”„ Tracking GitHub issue in Sentry"

          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"

          echo "ğŸ“‹ Issue Details:"
          echo "   Number: $ISSUE_NUMBER"
          echo "   Title: $ISSUE_TITLE"
          echo "   Author: $ISSUE_AUTHOR"
          echo "   URL: $ISSUE_URL"

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ event Ğ² Sentry
          SENTRY_EVENT_ID=$(openssl rand -hex 16)

          # ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ JSON payload Ğ±ĞµĞ· ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹
          cat > /tmp/sentry_event.json <<EVENT_EOF
          {
            "event_id": "$SENTRY_EVENT_ID",
            "level": "info",
            "message": "GitHub Issue Created: $ISSUE_TITLE",
            "environment": "tracking",
            "logger": "github",
            "tags": {
              "github_issue_number": "$ISSUE_NUMBER",
              "github_repository": "${{ github.repository }}",
              "issue_author": "$ISSUE_AUTHOR",
              "sync_direction": "github_to_sentry"
            },
            "extra": {
              "github_issue_url": "$ISSUE_URL",
              "github_issue_title": "$ISSUE_TITLE",
              "github_issue_number": $ISSUE_NUMBER,
              "github_repository": "${{ github.repository }}",
              "sync_timestamp": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            },
            "fingerprint": ["github-issue", "${{ github.repository }}", "$ISSUE_NUMBER"]
          }
EVENT_EOF

          echo "ğŸ“¦ Sentry event JSON prepared:"
          cat /tmp/sentry_event.json
          echo ""

          # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Sentry
          if [ -n "$SENTRY_API_KEY" ]; then
            echo "ğŸ”‘ Sending event to Sentry..."

            RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer $SENTRY_API_KEY" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Sentry-Sync/1.0" \
              -d @/tmp/sentry_event.json \
              "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/events/")

            echo "âœ… Sentry response:"
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

            if echo "$RESPONSE" | grep -q "id"; then
              echo "âœ… Successfully tracked issue in Sentry!"
            else
              echo "âš ï¸ Event sent, but response unclear"
            fi
          else
            echo "âš ï¸ SENTRY_API_KEY not set, skipping Sentry tracking"
            echo "To enable tracking, add SENTRY_API_KEY to repository secrets"
          fi

      - name: Add confirmation comment
        run: |
          echo "ğŸ“ Adding confirmation comment to issue #${{ github.event.issue.number }}"

          COMMENT_BODY="## âœ… Issue Registered in Tracking Center

This GitHub issue has been automatically registered in the central tracking system.

### ğŸ“‹ Registration Details
- **GitHub Issue:** #${{ github.event.issue.number }}
- **Repository:** ${{ github.repository }}
- **Status:** âœ… Registered
- **Timestamp:** $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")

### ğŸ¯ What's Next?
- The issue is now tracked in the central monitoring system
- You can monitor progress through this GitHub interface
- All updates will be synchronized with the tracking center

---
_ğŸ¤– Auto-registered by GitHub-to-Center Sync Action_"

          gh issue comment ${{ github.event.issue.number }} \
            --body "$COMMENT_BODY"

      - name: Show summary
        run: |
          echo ""
          echo "ğŸ“Š Summary:"
          echo "   âœ… Issue #${{ github.event.issue.number }} tracked successfully"
          echo "   ğŸ“ Repository: ${{ github.repository }}"
          echo "   ğŸ• Time: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")"
          echo ""

  close-issue:
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Mark issue as resolved in Sentry
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
        run: |
          echo "ğŸ”„ Closing GitHub issue #${{ github.event.issue.number }} in Sentry"

          ISSUE_NUMBER=${{ github.event.issue.number }}
          SENTRY_EVENT_ID=$(openssl rand -hex 16)

          cat > /tmp/sentry_close.json <<CLOSE_EOF
          {
            "event_id": "$SENTRY_EVENT_ID",
            "level": "info",
            "message": "GitHub Issue Closed: #$ISSUE_NUMBER",
            "environment": "tracking",
            "logger": "github",
            "tags": {
              "github_issue_number": "$ISSUE_NUMBER",
              "github_repository": "${{ github.repository }}",
              "sync_direction": "github_close_to_sentry"
            },
            "extra": {
              "github_issue_number": $ISSUE_NUMBER,
              "github_repository": "${{ github.repository }}",
              "closed_at": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            },
            "fingerprint": ["github-issue-closed", "${{ github.repository }}", "$ISSUE_NUMBER"]
          }
CLOSE_EOF

          if [ -n "$SENTRY_API_KEY" ]; then
            curl -s -X POST \
              -H "Authorization: Bearer $SENTRY_API_KEY" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Sentry-Sync/1.0" \
              -d @/tmp/sentry_close.json \
              "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/events/" > /dev/null

            echo "âœ… Closure event sent to Sentry"
          fi

      - name: Add closure comment
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "## âœ… Issue Closed

This GitHub issue has been closed and the tracking center has been updated.

### ğŸ“‹ Closure Details
- **GitHub Issue:** #${{ github.event.issue.number }}
- **Status:** ğŸ”’ Closed
- **Closed at:** $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")

---
_ğŸ¤– Auto-updated by GitHub-to-Center Sync Action_"
