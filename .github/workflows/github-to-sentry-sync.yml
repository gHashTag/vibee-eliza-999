name: GitHub Issues ‚Üí Sentry Tracker

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:

env:
  SENTRY_ORG: vibee
  SENTRY_PROJECT: eliza

jobs:
  create-issue-in-sentry:
    if: >
      (github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'reopened'))
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Create Sentry Issue from GitHub Issue
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          echo "üîÑ Creating Sentry issue from GitHub issue #${{ github.event.issue.number }}"

          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"

          # –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è Sentry
          SENTRY_EVENT_ID=$(openssl rand -hex 16)

          # –°–æ–∑–¥–∞—Ç—å event –≤ Sentry —Å —Ç–∏–ø–æ–º "github_issue"
          SENTRY_PAYLOAD=$(cat <<EOF
          {
            "event_id": "$SENTRY_EVENT_ID",
            "level": "info",
            "message": "GitHub Issue: $ISSUE_TITLE",
            "environment": "tracking",
            "logger": "github",
            "tags": {
              "github_issue_number": "$ISSUE_NUMBER",
              "github_issue_type": "user_report",
              "github_repository": "${{ github.repository }}",
              "sync_status": "github_to_sentry"
            },
            "extra": {
              "github_issue": {
                "number": $ISSUE_NUMBER,
                "title": $(echo "$ISSUE_TITLE" | jq -Rs .),
                "url": "$ISSUE_URL",
                "author": "$ISSUE_AUTHOR",
                "labels": $(echo '${{ toJson(github.event.issue.labels) }}' | jq -c '.[] | .name'),
                "body": $(echo "$ISSUE_BODY" | jq -Rs . | cut -c1-1000),
                "created_at": "${{ github.event.issue.created_at }}",
                "updated_at": "${{ github.event.issue.updated_at }}"
              },
              "github_repository": "${{ github.repository }}",
              "github_issue_url": "$ISSUE_URL",
              "sync_timestamp": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            },
            "fingerprint": ["github-issue", "${{ github.repository }}", "$ISSUE_NUMBER"]
          }
          EOF
          )

          echo "üì¶ Sentry payload prepared"
          echo "$SENTRY_PAYLOAD" | jq '.'

          # –û—Ç–ø—Ä–∞–≤–∏—Ç—å event –≤ Sentry
          if [ -n "$SENTRY_API_KEY" ]; then
            echo "üîë Sentry API key found, sending event..."

            RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer $SENTRY_API_KEY" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Sentry-Sync/1.0" \
              -d "$SENTRY_PAYLOAD" \
              "https://sentry.io/api/$SENTRY_ORG/$SENTRY_PROJECT/events/")

            echo "‚úÖ Sentry response:"
            echo "$RESPONSE" | jq '.'

            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ event –±—ã–ª –ø—Ä–∏–Ω—è—Ç
            if echo "$RESPONSE" | jq -e '.id' > /dev/null; then
              SENTRY_EVENT_ID=$(echo "$RESPONSE" | jq -r '.id')
              echo "‚úÖ Successfully created Sentry event: $SENTRY_EVENT_ID"
            else
              echo "‚ùå Failed to create Sentry event"
              echo "Response: $RESPONSE"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è Sentry API key not found, skipping Sentry sync"
            echo "To enable Sentry sync, add SENTRY_API_KEY to repository secrets"
          fi

      - name: Add tracking comment to GitHub issue
        if: always()
        run: |
          echo "üìù Adding tracking comment to GitHub issue #${{ github.event.issue.number }}"

          # –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ GitHub issue –æ —Ç–æ–º, —á—Ç–æ –æ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å Sentry
          gh issue comment ${{ github.event.issue.number }} \
            --body "## üìä Issue Tracking Registered

This GitHub issue has been automatically registered in the tracking center.

### üìã Registration Details
- **GitHub Issue:** #${{ github.event.issue.number }}
- **Repository:** ${{ github.repository }}
- **Status:** ‚úÖ Registered
- **Timestamp:** $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")

### üéØ What's Next?
- The issue is now tracked in the central monitoring system
- You'll receive updates if there are related errors or events
- Progress can be monitored through the GitHub interface

### üìå Note
This is an automatic registration message. You can safely delete this comment if needed.

---
_ü§ñ Auto-registered by GitHub-to-Center Sync Action_"

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ GitHub issue #${{ github.event.issue.number }} successfully registered in Sentry"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Failed to register GitHub issue #${{ github.event.issue.number }} in Sentry"
          echo "Check the logs above for details"

  update-issue-in-sentry:
    if: >
      (github.event_name == 'issue_comment' && github.event.action == 'created')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Update Sentry with new comment
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
        run: |
          echo "üîÑ Updating Sentry tracking for issue #${{ github.event.issue.number }}"

          ISSUE_NUMBER=${{ github.event.issue.number }}
          COMMENT_BODY="${{ github.event.comment.body }}"
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"

          # –°–æ–∑–¥–∞—Ç—å event –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
          SENTRY_EVENT_ID=$(openssl rand -hex 16)

          SENTRY_PAYLOAD=$(cat <<EOF
          {
            "event_id": "$SENTRY_EVENT_ID",
            "level": "info",
            "message": "GitHub Issue Updated: #$ISSUE_NUMBER",
            "environment": "tracking",
            "logger": "github",
            "tags": {
              "github_issue_number": "$ISSUE_NUMBER",
              "github_issue_type": "update",
              "github_repository": "${{ github.repository }}",
              "sync_status": "github_update_to_sentry"
            },
            "extra": {
              "github_issue_update": {
                "number": $ISSUE_NUMBER,
                "comment_author": "$COMMENT_AUTHOR",
                "comment_body": $(echo "$COMMENT_BODY" | jq -Rs . | cut -c1-500),
                "updated_at": "${{ github.event.comment.created_at }}"
              },
              "github_repository": "${{ github.repository }}",
              "sync_timestamp": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            },
            "fingerprint": ["github-issue-update", "${{ github.repository }}", "$ISSUE_NUMBER"]
          }
          EOF
          )

          echo "üì¶ Sending update to Sentry..."

          if [ -n "$SENTRY_API_KEY" ]; then
            curl -s -X POST \
              -H "Authorization: Bearer $SENTRY_API_KEY" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Sentry-Sync/1.0" \
              -d "$SENTRY_PAYLOAD" \
              "https://sentry.io/api/$SENTRY_ORG/$SENTRY_PROJECT/events/" > /dev/null

            echo "‚úÖ Sentry tracking updated"
          fi

  close-issue-in-sentry:
    if: >
      (github.event_name == 'issues' && github.event.action == 'closed')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Mark issue as resolved in Sentry
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
        run: |
          echo "üîÑ Closing GitHub issue #${{ github.event.issue.number }} in Sentry tracking"

          # –°–æ–∑–¥–∞—Ç—å event –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
          SENTRY_EVENT_ID=$(openssl rand -hex 16)

          SENTRY_PAYLOAD=$(cat <<EOF
          {
            "event_id": "$SENTRY_EVENT_ID",
            "level": "info",
            "message": "GitHub Issue Closed: #${{ github.event.issue.number }}",
            "environment": "tracking",
            "logger": "github",
            "tags": {
              "github_issue_number": "${{ github.event.issue.number }}",
              "github_issue_type": "closed",
              "github_repository": "${{ github.repository }}",
              "sync_status": "github_close_to_sentry"
            },
            "extra": {
              "github_issue_closed": {
                "number": ${{ github.event.issue.number }},
                "closed_by": "${{ github.event.issue.user.login }}",
                "closed_at": "${{ github.event.issue.closed_at }}"
              },
              "github_repository": "${{ github.repository }}",
              "sync_timestamp": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            },
            "fingerprint": ["github-issue-closed", "${{ github.repository }}", "${{ github.event.issue.number }}"]
          }
          EOF
          )

          echo "üì¶ Sending close event to Sentry..."

          if [ -n "$SENTRY_API_KEY" ]; then
            curl -s -X POST \
              -H "Authorization: Bearer $SENTRY_API_KEY" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Sentry-Sync/1.0" \
              -d "$SENTRY_PAYLOAD" \
              "https://sentry.io/api/$SENTRY_ORG/$SENTRY_PROJECT/events/" > /dev/null

            echo "‚úÖ Sentry tracking updated with closure"
          fi

      - name: Add closure comment
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "## ‚úÖ Issue Closed

This GitHub issue has been closed and the tracking center has been updated.

### üìã Closure Details
- **GitHub Issue:** #${{ github.event.issue.number }}
- **Status:** üîí Closed
- **Closed at:** $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")
- **Repository:** ${{ github.repository }}

### üéØ What's Done
- Issue is marked as resolved in the tracking system
- Related events have been updated
- Tracking entry is now archived

---
_ü§ñ Auto-updated by GitHub-to-Center Sync Action_"
