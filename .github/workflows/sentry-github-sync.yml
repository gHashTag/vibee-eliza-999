name: Sentry ‚Üî GitHub Issues Sync

on:
  # Webhook –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º (Sentry)
  repository_dispatch:
    types: [sentry-error]
  # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
  schedule:
    - cron: '0 */2 * * *'
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:
    inputs:
      create_for_all:
        description: 'Create issues for all unresolved errors'
        required: false
        default: 'false'
        type: boolean

env:
  SENTRY_ORG: vibee
  SENTRY_PROJECT: eliza

jobs:
  handle-sentry-event:
    if: github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Extract Sentry Event Data
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload || context.payload;
            console.log('üì¶ Received Sentry event:', JSON.stringify(payload, null, 2));

            const event = payload.event || payload;
            const title = event.title || event.message || 'Unknown Error';
            const level = event.level || 'error';
            const errorId = event.eventID || event.id || event.error_id;
            const environment = event.environment || 'unknown';
            const firstSeen = event.firstSeen || new Date().toISOString();
            const logger = event.logger || 'unknown';

            core.setOutput('title', title);
            core.setOutput('level', level);
            core.setOutput('error_id', errorId);
            core.setOutput('environment', environment);
            core.setOutput('first_seen', firstSeen);
            core.setOutput('logger', logger);

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å title –¥–ª—è GitHub
            let formattedTitle = '';
            switch(level) {
              case 'fatal':
                formattedTitle = `üí• ${title}`;
                break;
              case 'error':
                formattedTitle = `üö® ${title}`;
                break;
              case 'warning':
                formattedTitle = `‚ö†Ô∏è ${title}`;
                break;
              default:
                formattedTitle = `‚ÑπÔ∏è ${title}`;
            }

            core.setOutput('formatted_title', formattedTitle);

      - name: Find Existing Issue
        id: find
        run: |
          echo "üîç Searching for existing issue with Sentry ID: ${{ steps.extract.outputs.error_id }}"

          # –ü–æ–∏—Å–∫ –ø–æ body –∏ title
          SEARCH_QUERY="Sentry ID: ${{ steps.extract.outputs.error_id }} repo:${{ github.repository }} state:open"
          ISSUE_NUMBER=$(gh issue list --search "$SEARCH_QUERY" --json number --jq '.[0].number // empty')

          if [ -n "$ISSUE_NUMBER" ] && [ "$ISSUE_NUMBER" != "null" ]; then
            echo "‚úÖ Found existing issue: #$ISSUE_NUMBER"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No existing issue found"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Existing Issue
        if: steps.find.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = '${{ steps.find.outputs.issue_number }}';
            const level = '${{ steps.extract.outputs.level }}';

            // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –Ω–æ–≤–æ–º occurrence
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issue_number),
              body: `‚ö†Ô∏è **New occurrence detected**

              - **Level:** ${level}
              - **Environment:** ${{ steps.extract.outputs.environment }}
              - **Time:** ${new Date().toISOString()}

              [View in Sentry](https://sentry.io/organizations/vibee/issues/${{ steps.extract.outputs.error_id }}/)

              _Auto-generated update_`
            });

            console.log(`üí¨ Added comment to issue #${issue_number}`);

      - name: Create GitHub Issue
        if: steps.find.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '${{ steps.extract.outputs.formatted_title }}',
              body: `
              ## üö® Sentry Error Alert

              ### üìã Error Information
              | Field | Value |
              |-------|-------|
              | **Sentry ID** | ${{ steps.extract.outputs.error_id }} |
              | **Level** | ${{ steps.extract.outputs.level }} |
              | **Environment** | ${{ steps.extract.outputs.environment }} |
              | **Logger** | ${{ steps.extract.outputs.logger }} |
              | **First Seen** | ${{ steps.extract.outputs.first_seen }} |

              ---

              ### üéØ Actions Required
              - [ ] üîç Investigate error in Sentry
              - [ ] üîé Identify root cause
              - [ ] üõ†Ô∏è Implement fix
              - [ ] ‚úÖ Test fix in staging
              - [ ] üöÄ Deploy to production
              - [ ] üìù Update this issue with resolution details

              ---

              ### üîó Useful Links
              - [View in Sentry](https://sentry.io/organizations/vibee/issues/${{ steps.extract.outputs.error_id }}/)
              - [Sentry Dashboard](https://sentry.io/organizations/vibee/projects/eliza/)
              - [Sentry Performance](https://sentry.io/organizations/vibee/performance/)

              ---

              _ü§ñ Auto-generated by Sentry-GitHub Sync Action_
              `,
              labels: [
                'bug',
                'sentry',
                'auto-created',
                'priority-high',
                '${{ steps.extract.outputs.level }}'
              ]
            });

            console.log('‚úÖ Created GitHub Issue:', data.html_url);

            // –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: data.number,
              body: `ü§ñ **Issue created automatically from Sentry error**

              This issue was automatically generated because a new error was detected in Sentry.

              **Next steps:**
              1. Click the Sentry link above to investigate the error
              2. Check the stack trace and identify the root cause
              3. Implement a fix
              4. Test the fix thoroughly
              5. Close this issue when the fix is deployed

              **For help:**
              - Check the error timeline in Sentry
              - Review recent deployments
              - Look at related errors for patterns
              - Use the search functionality to find similar issues

              _Please keep this issue updated with your progress_`
            });

      - name: Send Slack Notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            üö® Sentry-GitHub Sync failed
            Error: ${{ job.status }}
            Repository: ${{ github.repository }}
            Issue: ${{ steps.find.outputs.exists == 'false' && 'created' || 'updated' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  periodic-sync:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_for_all == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch Unresolved Errors from Sentry
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
        run: |
          echo "üîç Fetching unresolved errors from Sentry..."

          # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –Ω–µ—Ä–µ—à–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
          RESPONSE=$(curl -s -H "Authorization: Bearer $SENTRY_API_KEY" \
            "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/issues/?query=is:unresolved&limit=100")

          echo "üì¶ Raw response received"
          echo "$RESPONSE" | jq '.' > /tmp/sentry_issues.json

          # –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ —Å count >= 5 (—á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏)
          /tmp/sentry_issues.json | jq -r '.[] | select(.count >= 5) | "\(.id)|\(.title)|\(.level)|\(.count)|\(.firstSeen)"' \
            > /tmp/high_volume_errors.txt

          if [ -s /tmp/high_volume_errors.txt ]; then
            ERROR_COUNT=$(wc -l < /tmp/high_volume_errors.txt)
            echo "‚úÖ Found $ERROR_COUNT high-volume errors (count >= 5)"
            echo "üìä Top 5 errors:"
            head -5 /tmp/high_volume_errors.txt | while IFS='|' read -r id title level count first_seen; do
              echo "   - $title (occurrences: $count, level: $level)"
            done
          else
            echo "‚ÑπÔ∏è No high-volume errors found"
            echo "0" > /tmp/error_count.txt
          fi

      - name: Process Errors
        run: |
          if [ -s /tmp/high_volume_errors.txt ]; then
            echo "$ERROR_COUNT" > /tmp/error_count.txt
            echo "Processing $(wc -l < /tmp/high_volume_errors.txt) errors..."
          else
            echo "0" > /tmp/error_count.txt
          fi

      - name: Create Issues for High-Volume Errors
        run: |
          ERROR_COUNT=$(cat /tmp/error_count.txt)

          if [ "$ERROR_COUNT" -gt "0" ]; then
            echo "üìù Creating/updating GitHub issues..."

            while IFS='|' read -r error_id title level count first_seen; do
              echo "üîÑ Processing error: $error_id"
              echo "   Title: $title"
              echo "   Count: $count, Level: $level"

              # –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ issue
              SEARCH_QUERY="Sentry ID: $error_id repo:${{ github.repository }} state:open"
              EXISTING_ISSUE=$(gh issue list --search "$SEARCH_QUERY" --json number --jq '.[0].number // empty')

              if [ -n "$EXISTING_ISSUE" ] && [ "$EXISTING_ISSUE" != "null" ]; then
                echo "   ‚úÖ Updating existing issue #$EXISTING_ISSUE"

                # –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                gh issue comment $EXISTING_ISSUE \
                  --body "üîÑ **Periodic Sync Update**

                  - **Occurrences:** $count (increased)
                  - **Last Check:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

                  [View in Sentry](https://sentry.io/organizations/vibee/issues/$error_id/)
                  "
              else
                echo "   üÜï Creating new issue"

                # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ count
                PRIORITY_LABEL=""
                if [ "$count" -ge 100 ]; then
                  PRIORITY_LABEL="priority-critical"
                elif [ "$count" -ge 50 ]; then
                  PRIORITY_LABEL="priority-high"
                else
                  PRIORITY_LABEL="priority-medium"
                fi

                # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π issue
                gh issue create \
                  --title "üî• HIGH VOLUME: $title (x$count)" \
                  --body "
                  ## ‚ö†Ô∏è High-Volume Error Detected

                  ### üìä Error Statistics
                  | Field | Value |
                  |-------|-------|
                  | **Sentry ID** | $error_id |
                  | **Occurrences** | $count |
                  | **Level** | $level |
                  | **First Seen** | $first_seen |

                  ---

                  ### üö® Why This is Critical
                  This error has occurred **$count times** and indicates a serious problem that needs immediate attention.

                  ### üéØ Required Actions
                  - [ ] **URGENT:** Investigate this error in Sentry
                  - [ ] Identify the root cause
                  - [ ] Implement a hotfix if possible
                  - [ ] Deploy fix to all environments
                  - [ ] Monitor for recurrence
                  - [ ] Add regression test

                  ---

                  ### üîó Links
                  - [View in Sentry](https://sentry.io/organizations/vibee/issues/$error_id/)
                  - [Error Timeline](https://sentry.io/organizations/vibee/issues/$error_id/?query=timeseries)

                  ---

                  _ü§ñ Auto-generated by Sentry Periodic Sync Action_
                  _Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")_
                  " \
                  --label "bug,sentry,auto-created,$PRIORITY_LABEL,high-volume" \
                  --assignee "${{ github.triggering_actor }}"

                echo "   ‚úÖ Created issue for error $error_id"
              fi
            done < /tmp/high_volume_errors.txt

            echo "üéâ Completed processing all errors"
          else
            echo "‚ÑπÔ∏è No errors to process"
          fi

      - name: Summary
        run: |
          ERROR_COUNT=$(cat /tmp/error_count.txt 2>/dev/null || echo "0")
          echo ""
          echo "üìä Sync Summary:"
          echo "   - Errors processed: $ERROR_COUNT"
          echo "   - Repository: ${{ github.repository }}"
          echo "   - Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "üìã Open Sentry-GitHub sync issues:"
          gh issue list --search "repo:${{ github.repository }} label:sentry state:open" --json number,title --jq '.[0:5] | .[] | "   #\(.number): \(.title)"' 2>/dev/null || echo "   None"

  sync-closed-issues:
    if: github.event.issue && github.event.action == 'closed'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Extract Sentry ID
        id: extract
        run: |
          # –ò–∑–≤–ª–µ—á—å Sentry ID –∏–∑ body –∏–ª–∏ title
          BODY="${{ github.event.issue.body }}"
          TITLE="${{ github.event.issue.title }}"

          # –ü–æ–∏—Å–∫ Sentry ID –≤ body
          SENTRY_ID=$(echo "$BODY" | grep -oP 'Sentry ID:\s*\K[0-9a-f]+' | head -1)

          if [ -z "$SENTRY_ID" ]; then
            # –ü–æ–∏—Å–∫ –≤ title
            SENTRY_ID=$(echo "$TITLE" | grep -oP '\[Sentry ID:\s*\K[0-9a-f]+' | head -1)
          fi

          if [ -z "$SENTRY_ID" ]; then
            # –ü–æ–∏—Å–∫ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
            SENTRY_ID=$(gh issue view ${{ github.event.issue.number }} --json comments --jq '.comments[] | select(.body | contains("Sentry ID:")) | .body' | grep -oP 'Sentry ID:\s*\K[0-9a-f]+' | head -1)
          fi

          if [ -n "$SENTRY_ID" ]; then
            echo "‚úÖ Found Sentry ID: $SENTRY_ID"
            echo "sentry_id=$SENTRY_ID" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No Sentry ID found in issue"
            echo "sentry_id=" >> $GITHUB_OUTPUT
          fi

      - name: Resolve Sentry Issue
        if: steps.extract.outputs.sentry_id != ''
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
        run: |
          SENTRY_ID="${{ steps.extract.outputs.sentry_id }}"

          echo "üîÑ Resolving Sentry issue: $SENTRY_ID"

          # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
          CURRENT_STATUS=$(curl -s -H "Authorization: Bearer $SENTRY_API_KEY" \
            "https://sentry.io/api/0/issues/$SENTRY_ID/" | jq -r '.status')

          echo "Current Sentry status: $CURRENT_STATUS"

          if [ "$CURRENT_STATUS" != "resolved" ]; then
            # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ resolved
            RESPONSE=$(curl -s -X PUT \
              -H "Authorization: Bearer $SENTRY_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{
                "status": "resolved",
                "public": false
              }' \
              "https://sentry.io/api/0/issues/$SENTRY_ID/")

            echo "‚úÖ Sentry issue resolved"
            echo "$RESPONSE" | jq '.'

            # –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ
            gh issue comment ${{ github.event.issue.number }} \
              --body "‚úÖ **GitHub Issue Closed**

              This issue has been closed. If the fix has been deployed, the corresponding Sentry issue has been automatically marked as resolved.

              - **GitHub Issue:** #${{ github.event.issue.number }}
              - **Sentry Issue:** $SENTRY_ID
              - **Resolved at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

              _Auto-generated by GitHub-Sentry Sync_"
          else
            echo "‚ÑπÔ∏è Sentry issue already resolved"
          fi

      - name: Notify on Sync Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            üö® Failed to sync GitHub issue to Sentry
            GitHub Issue: #${{ github.event.issue.number }}
            Sentry ID: ${{ steps.extract.outputs.sentry_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  cleanup-done-issues:
    if: github.event_name == 'schedule' && github.event.schedule == '0 2 * * 0'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Find Resolved Sentry Issues
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
        run: |
          echo "üßπ Finding resolved Sentry issues to cleanup..."

          # –ü–æ–ª—É—á–∏—Ç—å resolved issues –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
          curl -s -H "Authorization: Bearer $SENTRY_API_KEY" \
            "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/issues/?query=is:resolved&limit=100" \
            | jq -r '.[] | select(.lastSeen > (now - 604800)) | "\(.id)|\(.title)|\(.lastSeen)"' \
            > /tmp/resolved_issues.txt

          if [ -s /tmp/resolved_issues.txt ]; then
            echo "Found $(wc -l < /tmp/resolved_issues.txt) recently resolved issues"
          else
            echo "No recently resolved issues found"
          fi

      - name: Check for Open GitHub Issues
        run: |
          if [ -s /tmp/resolved_issues.txt ]; then
            while IFS='|' read -r issue_id title last_seen; do
              echo "Checking for GitHub issue with Sentry ID: $issue_id"

              # –ü–æ–∏—Å–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ GitHub issue
              SEARCH_QUERY="Sentry ID: $issue_id repo:${{ github.repository }} state:open"
              ISSUE_NUMBER=$(gh issue list --search "$SEARCH_QUERY" --json number --jq '.[0].number // empty')

              if [ -n "$ISSUE_NUMBER" ] && [ "$ISSUE_NUMBER" != "null" ]; then
                echo "Found open GitHub issue #$ISSUE_NUMBER for resolved Sentry issue $issue_id"

                # –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∑–∞–∫—Ä—ã—Ç—å issue
                gh issue comment $ISSUE_NUMBER \
                  --body "ü§ñ **Auto-sync Suggestion**

                  This issue appears to be resolved in Sentry (last seen: $last_seen).

                  If this fix has been deployed to production and verified, please consider closing this GitHub issue.

                  - **Sentry Issue:** $issue_id
                  - **Last Seen:** $last_seen
                  - **Action:** Close this GitHub issue if the fix is complete

                  _Auto-generated cleanup suggestion_"
              fi
            done < /tmp/resolved_issues.txt
          fi
