name: GitHub â†’ Sentry Sync

on:
  issues:
    types: [opened, reopened, closed]
  workflow_dispatch:

env:
  SENTRY_ORG: vasilev-dmitrii
  SENTRY_PROJECT: vibee-eliza-999-prod-2

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Sync GitHub Issue to Sentry
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          echo "ğŸ”„ Syncing GitHub issue to Sentry..."
          echo ""
          echo "ğŸ“‹ Event Info:"
          echo "   Event: ${{ github.event_name }}"
          echo "   Action: ${{ github.event.action }}"
          echo "   Issue: #${{ github.event.issue.number }}"
          echo "   Title: ${{ github.event.issue.title }}"
          echo ""

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ² Sentry
          EVENT_ID=$(openssl rand -hex 16)
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ JSON Ñ„Ğ°Ğ¹Ğ»
          cat > /tmp/sentry_event.json <<EOF
          {
            "event_id": "$EVENT_ID",
            "level": "info",
            "message": "GitHub Issue ${{ github.event.action }}: #${{ github.event.issue.number }}",
            "environment": "tracking",
            "logger": "github",
            "tags": {
              "github_issue_number": "${{ github.event.issue.number }}",
              "github_issue_action": "${{ github.event.action }}",
              "github_repository": "${{ github.repository }}",
              "sync_direction": "github_to_sentry"
            },
            "extra": {
              "github_issue_url": "${{ github.event.issue.html_url }}",
              "github_issue_title": "${{ github.event.issue.title }}",
              "github_issue_body": "${{ github.event.issue.body }}",
              "github_issue_author": "${{ github.event.issue.user.login }}",
              "github_repository": "${{ github.repository }}",
              "sync_timestamp": "$TIMESTAMP"
            },
            "fingerprint": ["github-issue", "${{ github.repository }}", "${{ github.event.issue.number }}"]
          }
EOF

          echo "ğŸ“¦ Event JSON prepared"
          echo ""

          # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Sentry
          if [ -n "$SENTRY_API_KEY" ]; then
            echo "ğŸš€ Sending to Sentry..."
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer $SENTRY_API_KEY" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Sentry-Sync/1.0" \
              -d @/tmp/sentry_event.json \
              "https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/events/")

            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)

            if [ "$HTTP_CODE" = "201" ]; then
              echo "âœ… Event sent successfully!"
              echo "ğŸ“¡ Response: $HTTP_CODE"
              echo ""
              echo "ğŸ” Check Sentry Dashboard:"
              echo "https://$SENTRY_ORG.sentry.io/projects/$SENTRY_PROJECT/"
            else
              echo "âš ï¸ HTTP Status: $HTTP_CODE"
              echo "ğŸ“‹ Response:"
              echo "$RESPONSE_BODY"
            fi
          else
            echo "âš ï¸ SENTRY_API_KEY not set"
          fi

      - name: Add confirmation comment
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        run: |
          echo "ğŸ“ Adding confirmation comment..."

          COMMENT="## âœ… Issue Registered in Sentry

This GitHub issue has been automatically registered in the central tracking system.

### ğŸ“‹ Details
- **Issue:** #${{ github.event.issue.number }}
- **Action:** ${{ github.event.action }}
- **Repository:** ${{ github.repository }}
- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

### ğŸ” Check Sentry
View in Sentry: https://vasilev-dmitrii.sentry.io/projects/vibee-eliza-999-prod-2/

---
_ğŸ¤– Auto-registered by GitHubâ†’Sentry Sync_"

          gh issue comment ${{ github.event.issue.number }} \
            --body "$COMMENT"

      - name: Add closure comment
        if: github.event.action == 'closed'
        run: |
          echo "ğŸ“ Adding closure comment..."

          gh issue comment ${{ github.event.issue.number }} \
            --body "## ğŸ”’ Issue Closed

This GitHub issue has been closed and the tracking system has been updated.

### ğŸ“‹ Details
- **Issue:** #${{ github.event.issue.number }}
- **Status:** Closed
- **Closed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

---
_ğŸ¤– Auto-updated by GitHubâ†’Sentry Sync_"
