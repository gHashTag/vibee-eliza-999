name: Test Sentry API

on:
  workflow_dispatch:

jobs:
  test-sentry:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Test Sentry API Connection
        env:
          SENTRY_API_KEY: ${{ secrets.SENTRY_API_KEY }}
          SENTRY_ORG: vasilev-dmitrii
          SENTRY_PROJECT: vibee-eliza-999-prod-2
        run: |
          echo "üîÑ Testing Sentry API connection..."
          echo ""

          echo "üìã Configuration:"
          echo "   Organization: $SENTRY_ORG"
          echo "   Project: $SENTRY_PROJECT"
          echo "   API Key: ${SENTRY_API_KEY:0:10}..."
          echo ""

          if [ -z "$SENTRY_API_KEY" ]; then
            echo "‚ùå ERROR: SENTRY_API_KEY not set"
            exit 1
          fi

          echo "‚úÖ API Key found"
          echo ""

          # –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
          EVENT_ID=$(openssl rand -hex 16)
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          echo "üì¶ Creating test event..."
          echo "   Event ID: $EVENT_ID"
          echo "   Timestamp: $TIMESTAMP"
          echo ""

          # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π payload
          cat > /tmp/test_event.json <<EOF
          {
            "event_id": "$EVENT_ID",
            "level": "info",
            "message": "GitHub Actions Test Event",
            "environment": "tracking",
            "logger": "github-actions-test",
            "tags": {
              "test": "true",
              "source": "workflow_dispatch"
            },
            "extra": {
              "test_timestamp": "$TIMESTAMP",
              "workflow_run": "${{ github.run_id }}",
              "repository": "${{ github.repository }}"
            }
          }
EOF

          echo "üìÑ Test event JSON:"
          cat /tmp/test_event.json
          echo ""
          echo ""

          # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Sentry
          echo "üöÄ Sending to Sentry API..."
          API_URL="https://sentry.io/api/0/projects/$SENTRY_ORG/$SENTRY_PROJECT/events/"
          echo "   URL: $API_URL"
          echo ""

          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            -H "Authorization: Bearer $SENTRY_API_KEY" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions-Test/1.0" \
            -d @/tmp/test_event.json \
            "$API_URL")

          # –ò–∑–≤–ª–µ—á—å —Å—Ç–∞—Ç—É—Å –∫–æ–¥
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          echo "üì° Response HTTP Status: $HTTP_STATUS"
          echo ""

          if [ "$HTTP_STATUS" = "201" ]; then
            echo "‚úÖ SUCCESS! Event accepted by Sentry"
            echo ""
            echo "üìã Response body:"
            echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
            echo ""
            echo "üîç Check your Sentry dashboard:"
            echo "https://$SENTRY_ORG.sentry.io/projects/$SENTRY_PROJECT/"
            echo ""
            echo "Look for events with:"
            echo "   - Logger: github-actions-test"
            echo "   - Message: GitHub Actions Test Event"
          else
            echo "‚ùå FAILED! HTTP Status: $HTTP_STATUS"
            echo ""
            echo "üìã Response body:"
            echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
            echo ""
            echo "üîç Possible issues:"
            echo "1. Invalid SENTRY_API_KEY"
            echo "2. Wrong organization/project names"
            echo "3. Insufficient API key permissions"
            echo "4. Project does not exist or is archived"
            exit 1
          fi
